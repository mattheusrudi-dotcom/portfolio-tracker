<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Portfolio Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dashboard-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .asset-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .advice-section {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 10px 0;
        }
        .recommendation {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .buy {
            background-color: #e8f5e9;
            border-left: 4px solid #2ecc71;
        }
        .sell {
            background-color: #ffebee;
            border-left: 4px solid #e74c3c;
        }
        .hold {
            background-color: #e3f2fd;
            border-left: 4px solid #3498db;
        }
        .news-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .last-updated {
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: right;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        @media (max-width: 768px) {
            .asset-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>My Investment Portfolio Tracker</h1>
        <div class="last-updated">Loading data...</div>
    </header>

    <div class="dashboard-section">
        <h2>Portfolio Overview</h2>
        <div class="chart-container">
            <canvas id="totalValueChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="profitLossChart"></canvas>
        </div>
    </div>

    <div class="dashboard-section">
        <h2>Individual Assets</h2>
        <div class="asset-grid" id="assetGrid">
            <!-- Assets will be loaded here -->
            <p class="loading">Loading asset data... (This may take a minute)</p>
        </div>
    </div>

    <div class="dashboard-section">
        <h2>Daily Portfolio Advice</h2>
        <div id="dailyAdvice">
            <p class="loading">Generating recommendations...</p>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = 'H159AXI6NYSGJ6D3'; // Your Alpha Vantage API key
        const PORTFOLIO = [
            { symbol: 'MSFT', shares: 10, costBasis: 250.00 }, // Microsoft
            { symbol: 'AAPL', shares: 5, costBasis: 150.00 },   // Apple
            { symbol: 'GOOGL', shares: 3, costBasis: 120.00 }, // Google
            { symbol: 'AMZN', shares: 2, costBasis: 100.00 },  // Amazon
            { symbol: 'TSLA', shares: 1, costBasis: 700.00 },  // Tesla
            { symbol: 'NVDA', shares: 2, costBasis: 300.00 },  // NVIDIA
            { symbol: 'META', shares: 3, costBasis: 200.00 }   // Meta
        ];
        const START_DATE = '2024-01-01'; // Changed to past date for actual data

        // Global data storage
        let portfolioData = {};
        let dailyValues = [];
        let dailyProfitLoss = [];

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolioData();
        });

        async function loadPortfolioData() {
            try {
                // Update loading status
                document.querySelector('.last-updated').textContent = 'Loading data...';
                
                // Clear loading message
                document.getElementById('assetGrid').innerHTML = '';
                
                // Load data for each asset with delay to respect API limits
                for (let i = 0; i < PORTFOLIO.length; i++) {
                    const asset = PORTFOLIO[i];
                    try {
                        document.querySelector('.last-updated').textContent = `Loading ${asset.symbol} (${i+1}/${PORTFOLIO.length})...`;
                        const data = await fetchStockData(asset.symbol);
                        portfolioData[asset.symbol] = {
                            data: data,
                            shares: asset.shares,
                            costBasis: asset.costBasis
                        };
                        createAssetCard(asset.symbol);
                        
                        // Add delay between requests (15 seconds to stay under 5 requests/minute)
                        if (i < PORTFOLIO.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 15000));
                        }
                    } catch (error) {
                        console.error(`Error loading ${asset.symbol}:`, error);
                        // Create card anyway with error message
                        const errorCard = document.createElement('div');
                        errorCard.className = 'asset-card';
                        errorCard.innerHTML = `
                            <h3>${asset.symbol} (${asset.shares} shares)</h3>
                            <p style="color: #e74c3c;">Error loading data. Please try again later.</p>
                        `;
                        document.getElementById('assetGrid').appendChild(errorCard);
                    }
                }
                
                // Calculate daily portfolio values
                calculateDailyPortfolioValues();
                
                // Create cumulative charts
                createTotalValueChart();
                createProfitLossChart();
                
                // Generate recommendations
                generateDailyAdvice();
                
                // Update timestamp
                const now = new Date();
                document.querySelector('.last-updated').textContent = `Last updated: ${now.toLocaleString()}`;
            } catch (error) {
                console.error('Error loading portfolio data:', error);
                document.querySelector('.last-updated').textContent = 'Error loading data. Please try again.';
            }
        }

        async function fetchStockData(symbol) {
            // Note: Alpha Vantage free tier has 5 requests per minute limit
            const response = await axios.get(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${API_KEY}&outputsize=compact`);
            
            if (response.data.Note) {
                throw new Error('API limit reached. Please wait and try again later.');
            }
            
            if (!response.data['Time Series (Daily)']) {
                throw new Error('Invalid data received from API');
            }
            
            // Process the data
            const timeSeries = response.data['Time Series (Daily)'];
            const processedData = [];
            
            for (const date in timeSeries) {
                if (new Date(date) >= new Date(START_DATE)) {
                    processedData.push({
                        date: date,
                        open: parseFloat(timeSeries[date]['1. open']),
                        high: parseFloat(timeSeries[date]['2. high']),
                        low: parseFloat(timeSeries[date]['3. low']),
                        close: parseFloat(timeSeries[date]['4. close']),
                        volume: parseInt(timeSeries[date]['5. volume'])
                    });
                }
            }
            
            // Sort by date ascending
            processedData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return processedData;
        }

        function createAssetCard(symbol) {
            const asset = portfolioData[symbol];
            const latestData = asset.data[asset.data.length - 1];
            const costValue = asset.shares * asset.costBasis;
            const currentValue = asset.shares * latestData.close;
            const profitLoss = currentValue - costValue;
            const profitLossPercent = (profitLoss / costValue) * 100;
            
            const card = document.createElement('div');
            card.className = 'asset-card';
            card.innerHTML = `
                <h3>${symbol} (${asset.shares} shares)</h3>
                <div class="chart-container">
                    <canvas id="${symbol}Chart"></canvas>
                </div>
                <div>
                    <p>Current Value: $${currentValue.toFixed(2)}</p>
                    <p>Cost Basis: $${costValue.toFixed(2)}</p>
                    <p>P/L: $${profitLoss.toFixed(2)} (${profitLossPercent.toFixed(2)}%)</p>
                </div>
            `;
            document.getElementById('assetGrid').appendChild(card);
            
            // Create chart for this asset
            createAssetChart(symbol);
        }

        function createAssetChart(symbol) {
            const asset = portfolioData[symbol];
            const ctx = document.getElementById(`${symbol}Chart`).getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: asset.data.map(item => item.date),
                    datasets: [{
                        label: `${symbol} Price`,
                        data: asset.data.map(item => item.close),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        }
                    }
                }
            });
        }

        function calculateDailyPortfolioValues() {
            // Get all unique dates across all assets
            const allDates = new Set();
            for (const symbol in portfolioData) {
                portfolioData[symbol].data.forEach(item => allDates.add(item.date));
            }
            
            const sortedDates = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));
            
            // Calculate portfolio value for each date
            dailyValues = [];
            dailyProfitLoss = [];
            
            sortedDates.forEach(date => {
                let dailyValue = 0;
                let dailyCost = 0;
                
                for (const symbol in portfolioData) {
                    const asset = portfolioData[symbol];
                    // Find the data point for this date (or the most recent before it)
                    const dataPoint = asset.data.find(item => item.date === date) || 
                                     asset.data.filter(item => item.date <= date).slice(-1)[0];
                    
                    if (dataPoint) {
                        dailyValue += asset.shares * dataPoint.close;
                        dailyCost += asset.shares * asset.costBasis;
                    }
                }
                
                if (dailyValue > 0) {
                    dailyValues.push({
                        date: date,
                        value: dailyValue
                    });
                    
                    dailyProfitLoss.push({
                        date: date,
                        profitLoss: dailyValue - dailyCost
                    });
                }
            });
        }

        function createTotalValueChart() {
            const ctx = document.getElementById('totalValueChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyValues.map(item => item.date),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: dailyValues.map(item => item.value),
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toFixed(2)}`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Value ($)'
                            }
                        }
                    }
                }
            });
        }

        function createProfitLossChart() {
            const ctx = document.getElementById('profitLossChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyProfitLoss.map(item => item.date),
                    datasets: [{
                        label: 'Profit/Loss',
                        data: dailyProfitLoss.map(item => item.profitLoss),
                        borderColor: function(context) {
                            return context.raw >= 0 ? '#2ecc71' : '#e74c3c';
                        },
                        backgroundColor: function(context) {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            if (context.raw >= 0) {
                                gradient.addColorStop(0, 'rgba(46, 204, 113, 0.2)');
                                gradient.addColorStop(1, 'rgba(46, 204, 113, 0)');
                            } else {
                                gradient.addColorStop(0, 'rgba(231, 76, 60, 0.2)');
                                gradient.addColorStop(1, 'rgba(231, 76, 60, 0)');
                            }
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toFixed(2)}`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'P/L ($)'
                            }
                        }
                    }
                }
            });
        }

        function generateDailyAdvice() {
            const adviceContainer = document.getElementById('dailyAdvice');
            adviceContainer.innerHTML = '';
            
            // Create header
            const now = new Date();
            const header = document.createElement('h3');
            header.textContent = `Recommendations for ${now.toLocaleDateString()}`;
            adviceContainer.appendChild(header);
            
            // Generate advice for each asset
            for (const symbol in portfolioData) {
                const asset = portfolioData[symbol];
                const latestData = asset.data[asset.data.length - 1];
                const prevData = asset.data[asset.data.length - 2];
                
                if (!latestData || !prevData) continue;
                
                const currentPrice = latestData.close;
                const prevPrice = prevData.close;
                const dailyChange = ((currentPrice - prevPrice) / prevPrice) * 100;
                const costBasis = asset.costBasis;
                const positionChange = ((currentPrice - costBasis) / costBasis) * 100;
                
                // Enhanced recommendation logic
                let recommendation, reason;
                
                // Check for strong trends
                const fiveDayAvg = asset.data.slice(-5).reduce((sum, item) => sum + item.close, 0) / 5;
                const twentyDayAvg = asset.data.slice(-20).reduce((sum, item) => sum + item.close, 0) / 20;
                const isUptrend = fiveDayAvg > twentyDayAvg;
                
                // Check volatility
                const recentHigh = Math.max(...asset.data.slice(-5).map(item => item.high));
                const recentLow = Math.min(...asset.data.slice(-5).map(item => item.low));
                const volatility = (recentHigh - recentLow) / recentLow * 100;
                
                if (positionChange > 25) {
                    recommendation = 'SELL';
                    reason = `Consider taking profits as this position is up ${positionChange.toFixed(1)}% from your cost basis.`;
                } else if (positionChange < -15 && isUptrend) {
                    recommendation = 'BUY';
                    reason = `Potential buying opportunity (down ${Math.abs(positionChange).toFixed(1)}%) with recent upward trend.`;
                } else if (dailyChange > 5 && volatility > 10) {
                    recommendation = 'SELL';
                    reason = `Consider locking in gains after a ${dailyChange.toFixed(1)}% surge with high volatility.`;
                } else if (dailyChange < -5 && isUptrend) {
                    recommendation = 'BUY';
                    reason = `Potential dip buying opportunity after ${Math.abs(dailyChange).toFixed(1)}% pullback in an uptrend.`;
                } else if (positionChange > 10 && !isUptrend) {
                    recommendation = 'SELL';
                    reason = `Consider selling as uptrend may be reversing (${positionChange.toFixed(1)}% gain but recent weakness).`;
                } else {
                    recommendation = 'HOLD';
                    reason = `Neutral price action. Current trend: ${isUptrend ? 'upward' : 'downward'}.`;
                }
                
                // Create recommendation element
                const recElement = document.createElement('div');
                recElement.className = `recommendation ${recommendation.toLowerCase()}`;
                recElement.innerHTML = `
                    <h4>${recommendation}: ${symbol}</h4>
                    <p>Current Price: $${currentPrice.toFixed(2)} (${dailyChange.toFixed(1)}% today)</p>
                    <p>Your Cost Basis: $${costBasis.toFixed(2)} (${positionChange.toFixed(1)}% ${positionChange >= 0 ? 'profit' : 'loss'})</p>
                    <p>Trend: ${isUptrend ? 'Upward' : 'Downward'} (5-day above 20-day: ${fiveDayAvg > twentyDayAvg ? 'Yes' : 'No'})</p>
                    <p>Volatility: ${volatility.toFixed(1)}% (5-day range)</p>
                    <p>${reason}</p>
                `;
                adviceContainer.appendChild(recElement);
            }
            
            // Add market news section (simulated - in a real app you'd fetch this)
            const newsSection = document.createElement('div');
            newsSection.className = 'advice-section';
            newsSection.innerHTML = `
                <h3>Market News Highlights</h3>
                <div class="news-item">
                    <strong>Tech Sector Update:</strong> Major tech companies reporting earnings this week. Expect increased volatility.
                </div>
                <div class="news-item">
                    <strong>Fed Meeting:</strong> Interest rate decision coming tomorrow could impact growth stocks.
                </div>
                <div class="news-item">
                    <strong>Economic Data:</strong> Strong jobs report suggests continued economic growth.
                </div>
                <div class="news-item">
                    <strong>Market Sentiment:</strong> Investor confidence remains strong despite recent volatility.
                </div>
            `;
            adviceContainer.appendChild(newsSection);
        }
    </script>
</body>
</html>